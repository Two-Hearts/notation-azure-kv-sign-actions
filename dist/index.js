require('./sourcemap-register.js');(()=>{var __webpack_modules__={593:(module,__unused_webpack_exports,__nccwpck_require__)=>{const os=__nccwpck_require__(37);const core=__nccwpck_require__(819);const execSync=__nccwpck_require__(81).execSync;const tc=__nccwpck_require__(401);const path=__nccwpck_require__(17);const fs=__nccwpck_require__(147);const mv=__nccwpck_require__(398);const akv_plugin_version="1.0.0-rc.2";const akv_plugin_name="azure-kv";const akv_subscription_id=process.env.AKV_SUBSCRIPTION_ID;const akv_name=process.env.AKV_NAME;const azure_service_principle_client_id=process.env.AZURE_SERVICE_PRINCIPLE_CLIENT_ID;function mapArch(e){const n={arm:"armv7",x64:"amd64"};return n[e]||e}function mapOS(e){const n={win32:"windows"};return n[e]||e}function getDownloadURL(){const e=os.platform();const n=`notation-azure-kv_${akv_plugin_version}_${mapOS(e)}_${mapArch(os.arch())}`;const o=e==="win32"?"zip":"tar.gz";return`https://github.com/Azure/notation-azure-kv/releases/download/v${akv_plugin_version}/${n}.${o}`}async function sign(){try{await setupAKVPlugin();let e=execSync(`notation plugin ls`,{encoding:"utf-8"});console.log("notation plugin list output:\n",e);const n=core.getInput("key_id");const o=core.getInput("target_artifact_reference");if(process.env.NOTATION_EXPERIMENTAL){execSync(`notation sign --signature-format cose --allow-referrers-api --id ${n} --plugin ${akv_plugin_name} ${o}`,{encoding:"utf-8"})}else{execSync(`notation sign --signature-format cose --id ${n} --plugin ${akv_plugin_name} ${o}`,{encoding:"utf-8"})}}catch(e){core.setFailed(e)}}async function setupAKVPlugin(){try{const e=core.getInput("plugin_oci_ref");if(e){execSync(`notation plugin install --name ${akv_plugin_name} ${e}`,{encoding:"utf-8"});console.log("Successfully installed notation-azure-akv plugin with `notation plugin install`")}else{const e=getDownloadURL();console.log(`notation-azure-kv url is ${e}`);const n=os.homedir()+`/.config/notation/plugins/${akv_plugin_name}`;fs.mkdirSync(n,{recursive:true});const o=await tc.downloadTool(e);const t=e.endsWith(".zip")?tc.extractZip:tc.extractTar;const _=await t(o);const i=path.join(_,"/",`notation-${akv_plugin_name}`);const c=path.join(n,"/",`notation-${akv_plugin_name}`);mv(i,c,(function(e){if(e){throw e}else{console.log(`Successfully moved the plugin file to ${c}`);fs.chmod(c,493,(e=>{if(e)throw e;console.log(`The permissions for file "${c}" have been changed`)}))}}))}execSync(`az account set -s ${akv_subscription_id}`,{encoding:"utf-8"});let n=execSync(`az keyvault set-policy -n ${akv_name} --secret-permissions get list --key-permissions sign --certificate-permissions get --spn ${azure_service_principle_client_id}`,{encoding:"utf-8"});console.log("az keyvault set-policy output:\n",n)}catch(e){core.setFailed(e)}}module.exports=sign;if(require.main===require.cache[eval("__filename")]){sign()}},819:module=>{module.exports=eval("require")("@actions/core")},401:module=>{module.exports=eval("require")("@actions/tool-cache")},398:module=>{module.exports=eval("require")("mv")},81:e=>{"use strict";e.exports=require("child_process")},147:e=>{"use strict";e.exports=require("fs")},37:e=>{"use strict";e.exports=require("os")},17:e=>{"use strict";e.exports=require("path")}};var __webpack_module_cache__={};function __nccwpck_require__(e){var n=__webpack_module_cache__[e];if(n!==undefined){return n.exports}var o=__webpack_module_cache__[e]={exports:{}};var t=true;try{__webpack_modules__[e](o,o.exports,__nccwpck_require__);t=false}finally{if(t)delete __webpack_module_cache__[e]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var __webpack_exports__=__nccwpck_require__(593);module.exports=__webpack_exports__})();
//# sourceMappingURL=index.js.map